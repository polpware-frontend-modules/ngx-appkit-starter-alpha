// =============================
// Email: info@ebenmonney.com
// www.ebenmonney.com/templates
// =============================
import { Injectable } from '@angular/core';
import { interval } from 'rxjs';
import { map, flatMap, startWith } from 'rxjs/operators';
import { Notification } from '../models/notification.model';
import * as i0 from "@angular/core";
import * as i1 from "./notification-endpoint.service";
import * as i2 from "@polpware/ngx-oauth2";
export class NotificationService {
    constructor(notificationEndpoint, authService) {
        this.notificationEndpoint = notificationEndpoint;
        this.authService = authService;
    }
    get currentUser() {
        return this.authService.currentUser;
    }
    get recentNotifications() {
        return this._recentNotifications;
    }
    set recentNotifications(notifications) {
        this._recentNotifications = notifications;
    }
    getNotification(notificationId) {
        return this.notificationEndpoint.getNotificationEndpoint(notificationId).pipe(map(response => Notification.Create(response)));
    }
    getNotifications(page, pageSize) {
        return this.notificationEndpoint.getNotificationsEndpoint(page, pageSize).pipe(map(response => {
            return this.getNotificationsFromResponse(response);
        }));
    }
    getUnreadNotifications(userId) {
        return this.notificationEndpoint.getUnreadNotificationsEndpoint(userId).pipe(map(response => this.getNotificationsFromResponse(response)));
    }
    getNewNotifications() {
        return this.notificationEndpoint.getNewNotificationsEndpoint(this.lastNotificationDate).pipe(map(response => this.processNewNotificationsFromResponse(response)));
    }
    getNewNotificationsPeriodically() {
        return interval(10000).pipe(startWith(0), flatMap(() => {
            return this.notificationEndpoint.getNewNotificationsEndpoint(this.lastNotificationDate).pipe(map(response => this.processNewNotificationsFromResponse(response)));
        }));
    }
    pinUnpinNotification(notificationOrNotificationId, isPinned) {
        if (typeof notificationOrNotificationId === 'number' || notificationOrNotificationId instanceof Number) {
            return this.notificationEndpoint.getPinUnpinNotificationEndpoint(notificationOrNotificationId, isPinned);
        }
        else {
            return this.pinUnpinNotification(notificationOrNotificationId.id);
        }
    }
    readUnreadNotification(notificationIds, isRead) {
        return this.notificationEndpoint.getReadUnreadNotificationEndpoint(notificationIds, isRead);
    }
    deleteNotification(notificationOrNotificationId) {
        if (typeof notificationOrNotificationId === 'number' || notificationOrNotificationId instanceof Number) { // Todo: Test me if its check is valid
            return this.notificationEndpoint.getDeleteNotificationEndpoint(notificationOrNotificationId).pipe(map(response => {
                this.recentNotifications = this.recentNotifications.filter(n => n.id != notificationOrNotificationId);
                return Notification.Create(response);
            }));
        }
        else {
            return this.deleteNotification(notificationOrNotificationId.id);
        }
    }
    processNewNotificationsFromResponse(response) {
        const notifications = this.getNotificationsFromResponse(response);
        for (const n of notifications) {
            if (n.date > this.lastNotificationDate) {
                this.lastNotificationDate = n.date;
            }
        }
        return notifications;
    }
    getNotificationsFromResponse(response) {
        const notifications = [];
        for (const i in response) {
            notifications[i] = Notification.Create(response[i]);
        }
        notifications.sort((a, b) => b.date.valueOf() - a.date.valueOf());
        notifications.sort((a, b) => (a.isPinned === b.isPinned) ? 0 : a.isPinned ? -1 : 1);
        this.recentNotifications = notifications;
        return notifications;
    }
}
/** @nocollapse */ NotificationService.ɵfac = function NotificationService_Factory(t) { return new (t || NotificationService)(i0.ɵɵinject(i1.NotificationEndpoint), i0.ɵɵinject(i2.AuthService)); };
/** @nocollapse */ NotificationService.ɵprov = i0.ɵɵdefineInjectable({ token: NotificationService, factory: NotificationService.ɵfac });
/*@__PURE__*/ (function () { i0.ɵsetClassMetadata(NotificationService, [{
        type: Injectable
    }], function () { return [{ type: i1.NotificationEndpoint }, { type: i2.AuthService }]; }, null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm90aWZpY2F0aW9uLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AcG9scHdhcmUvbmd4LWFwcGtpdC1zdGFydGVyLWFscGhhLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL25vdGlmaWNhdGlvbi5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLGdDQUFnQztBQUNoQyw2QkFBNkI7QUFDN0IsK0JBQStCO0FBQy9CLGdDQUFnQztBQUVoQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBYyxRQUFRLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDNUMsT0FBTyxFQUFFLEdBQUcsRUFBRSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFJekQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDhCQUE4QixDQUFDOzs7O0FBRzVELE1BQU0sT0FBTyxtQkFBbUI7SUFtQjVCLFlBQW9CLG9CQUEwQyxFQUFVLFdBQXdCO1FBQTVFLHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBc0I7UUFBVSxnQkFBVyxHQUFYLFdBQVcsQ0FBYTtJQUVoRyxDQUFDO0lBaEJELElBQUksV0FBVztRQUNYLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUM7SUFDeEMsQ0FBQztJQUVELElBQUksbUJBQW1CO1FBQ25CLE9BQU8sSUFBSSxDQUFDLG9CQUFvQixDQUFDO0lBQ3JDLENBQUM7SUFFRCxJQUFJLG1CQUFtQixDQUFDLGFBQTZCO1FBQ2pELElBQUksQ0FBQyxvQkFBb0IsR0FBRyxhQUFhLENBQUM7SUFDOUMsQ0FBQztJQVNELGVBQWUsQ0FBQyxjQUF1QjtRQUVuQyxPQUFPLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyx1QkFBdUIsQ0FBQyxjQUFjLENBQUMsQ0FBQyxJQUFJLENBQ3pFLEdBQUcsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENB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PT09PT09PT09PT09PT09PVxuLy8gRW1haWw6IGluZm9AZWJlbm1vbm5leS5jb21cbi8vIHd3dy5lYmVubW9ubmV5LmNvbS90ZW1wbGF0ZXNcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIGludGVydmFsIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtYXAsIGZsYXRNYXAsIHN0YXJ0V2l0aCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHsgQXV0aFNlcnZpY2UsIFVzZXIgfSBmcm9tICdAcG9scHdhcmUvbmd4LW9hdXRoMic7XG5pbXBvcnQgeyBOb3RpZmljYXRpb25FbmRwb2ludCB9IGZyb20gJy4vbm90aWZpY2F0aW9uLWVuZHBvaW50LnNlcnZpY2UnO1xuaW1wb3J0IHsgTm90aWZpY2F0aW9uIH0gZnJvbSAnLi4vbW9kZWxzL25vdGlmaWNhdGlvbi5tb2RlbCc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBOb3RpZmljYXRpb25TZXJ2aWNlIHtcblxuICAgIHByaXZhdGUgbGFzdE5vdGlmaWNhdGlvbkRhdGU6IERhdGU7XG4gICAgcHJpdmF0ZSBfcmVjZW50Tm90aWZpY2F0aW9uczogTm90aWZpY2F0aW9uW107XG5cbiAgICBnZXQgY3VycmVudFVzZXIoKTogVXNlciB7XG4gICAgICAgIHJldHVybiB0aGlzLmF1dGhTZXJ2aWNlLmN1cnJlbnRVc2VyO1xuICAgIH1cblxuICAgIGdldCByZWNlbnROb3RpZmljYXRpb25zKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fcmVjZW50Tm90aWZpY2F0aW9ucztcbiAgICB9XG5cbiAgICBzZXQgcmVjZW50Tm90aWZpY2F0aW9ucyhub3RpZmljYXRpb25zOiBOb3RpZmljYXRpb25bXSkge1xuICAgICAgICB0aGlzLl9yZWNlbnROb3RpZmljYXRpb25zID0gbm90aWZpY2F0aW9ucztcbiAgICB9XG5cblxuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBub3RpZmljYXRpb25FbmRwb2ludDogTm90aWZpY2F0aW9uRW5kcG9pbnQsIHByaXZhdGUgYXV0aFNlcnZpY2U6IEF1dGhTZXJ2aWNlKSB7XG5cbiAgICB9XG5cblxuICAgIGdldE5vdGlmaWNhdGlvbihub3RpZmljYXRpb25JZD86IG51bWJlcikge1xuXG4gICAgICAgIHJldHVybiB0aGlzLm5vdGlmaWNhdGlvbkVuZHBvaW50LmdldE5vdGlmaWNhdGlvbkVuZHBvaW50KG5vdGlmaWNhdGlvbklkKS5waXBlKFxuICAgICAgICAgICAgbWFwKHJlc3BvbnNlID0+IE5vdGlmaWNhdGlvbi5DcmVhdGUocmVzcG9uc2UpKSk7XG4gICAgfVxuXG5cbiAgICBnZXROb3RpZmljYXRpb25zKHBhZ2U6IG51bWJlciwgcGFnZVNpemU6IG51bWJlcikge1xuXG4gICAgICAgIHJldHVybiB0aGlzLm5vdGlmaWNhdGlvbkVuZHBvaW50LmdldE5vdGlmaWNhdGlvbnNFbmRwb2ludChwYWdlLCBwYWdlU2l6ZSkucGlwZShcbiAgICAgICAgICAgIG1hcChyZXNwb25zZSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0Tm90aWZpY2F0aW9uc0Zyb21SZXNwb25zZShyZXNwb25zZSk7XG4gICAgICAgICAgICB9KSk7XG4gICAgfVxuXG5cbiAgICBnZXRVbnJlYWROb3RpZmljYXRpb25zKHVzZXJJZD86IHN0cmluZykge1xuXG4gICAgICAgIHJldHVybiB0aGlzLm5vdGlmaWNhdGlvbkVuZHBvaW50LmdldFVucmVhZE5vdGlmaWNhdGlvbnNFbmRwb2ludCh1c2VySWQpLnBpcGUoXG4gICAgICAgICAgICBtYXAocmVzcG9uc2UgPT4gdGhpcy5nZXROb3RpZmljYXRpb25zRnJvbVJlc3BvbnNlKHJlc3BvbnNlKSkpO1xuICAgIH1cblxuXG4gICAgZ2V0TmV3Tm90aWZpY2F0aW9ucygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubm90aWZpY2F0aW9uRW5kcG9pbnQuZ2V0TmV3Tm90aWZpY2F0aW9uc0VuZHBvaW50KHRoaXMubGFzdE5vdGlmaWNhdGlvbkRhdGUpLnBpcGUoXG4gICAgICAgICAgICBtYXAocmVzcG9uc2UgPT4gdGhpcy5wcm9jZXNzTmV3Tm90aWZpY2F0aW9uc0Zyb21SZXNwb25zZShyZXNwb25zZSkpKTtcbiAgICB9XG5cblxuICAgIGdldE5ld05vdGlmaWNhdGlvbnNQZXJpb2RpY2FsbHkoKSB7XG4gICAgICAgIHJldHVybiBpbnRlcnZhbCgxMDAwMCkucGlwZShcbiAgICAgICAgICAgIHN0YXJ0V2l0aCgwKSxcbiAgICAgICAgICAgIGZsYXRNYXAoKCkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm5vdGlmaWNhdGlvbkVuZHBvaW50LmdldE5ld05vdGlmaWNhdGlvbnNFbmRwb2ludCh0aGlzLmxhc3ROb3RpZmljYXRpb25EYXRlKS5waXBlKFxuICAgICAgICAgICAgICAgICAgICBtYXAocmVzcG9uc2UgPT4gdGhpcy5wcm9jZXNzTmV3Tm90aWZpY2F0aW9uc0Zyb21SZXNwb25zZShyZXNwb25zZSkpKTtcbiAgICAgICAgICAgIH0pKTtcbiAgICB9XG5cblxuXG5cbiAgICBwaW5VbnBpbk5vdGlmaWNhdGlvbihub3RpZmljYXRpb25Pck5vdGlmaWNhdGlvbklkOiBudW1iZXIgfCBOb3RpZmljYXRpb24sIGlzUGlubmVkPzogYm9vbGVhbik6IE9ic2VydmFibGU8YW55PiB7XG5cbiAgICAgICAgaWYgKHR5cGVvZiBub3RpZmljYXRpb25Pck5vdGlmaWNhdGlvbklkID09PSAnbnVtYmVyJyB8fCBub3RpZmljYXRpb25Pck5vdGlmaWNhdGlvbklkIGluc3RhbmNlb2YgTnVtYmVyKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5ub3RpZmljYXRpb25FbmRwb2ludC5nZXRQaW5VbnBpbk5vdGlmaWNhdGlvbkVuZHBvaW50KG5vdGlmaWNhdGlvbk9yTm90aWZpY2F0aW9uSWQgYXMgbnVtYmVyLCBpc1Bpbm5lZCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5waW5VbnBpbk5vdGlmaWNhdGlvbihub3RpZmljYXRpb25Pck5vdGlmaWNhdGlvbklkLmlkKTtcbiAgICAgICAgfVxuICAgIH1cblxuXG4gICAgcmVhZFVucmVhZE5vdGlmaWNhdGlvbihub3RpZmljYXRpb25JZHM6IG51bWJlcltdLCBpc1JlYWQ6IGJvb2xlYW4pOiBPYnNlcnZhYmxlPGFueT4ge1xuXG4gICAgICAgIHJldHVybiB0aGlzLm5vdGlmaWNhdGlvbkVuZHBvaW50LmdldFJlYWRVbnJlYWROb3RpZmljYXRpb25FbmRwb2ludChub3RpZmljYXRpb25JZHMsIGlzUmVhZCk7XG4gICAgfVxuXG5cblxuXG4gICAgZGVsZXRlTm90aWZpY2F0aW9uKG5vdGlmaWNhdGlvbk9yTm90aWZpY2F0aW9uSWQ6IG51bWJlciB8IE5vdGlmaWNhdGlvbik6IE9ic2VydmFibGU8Tm90aWZpY2F0aW9uPiB7XG5cbiAgICAgICAgaWYgKHR5cGVvZiBub3RpZmljYXRpb25Pck5vdGlmaWNhdGlvbklkID09PSAnbnVtYmVyJyB8fCBub3RpZmljYXRpb25Pck5vdGlmaWNhdGlvbklkIGluc3RhbmNlb2YgTnVtYmVyKSB7IC8vIFRvZG86IFRlc3QgbWUgaWYgaXRzIGNoZWNrIGlzIHZhbGlkXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5ub3RpZmljYXRpb25FbmRwb2ludC5nZXREZWxldGVOb3RpZmljYXRpb25FbmRwb2ludChub3RpZmljYXRpb25Pck5vdGlmaWNhdGlvbklkIGFzIG51bWJlcikucGlwZShcbiAgICAgICAgICAgICAgICBtYXAocmVzcG9uc2UgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlY2VudE5vdGlmaWNhdGlvbnMgPSB0aGlzLnJlY2VudE5vdGlmaWNhdGlvbnMuZmlsdGVyKG4gPT4gbi5pZCAhPSBub3RpZmljYXRpb25Pck5vdGlmaWNhdGlvbklkKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE5vdGlmaWNhdGlvbi5DcmVhdGUocmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgIH0pKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmRlbGV0ZU5vdGlmaWNhdGlvbihub3RpZmljYXRpb25Pck5vdGlmaWNhdGlvbklkLmlkKTtcbiAgICAgICAgfVxuICAgIH1cblxuXG5cblxuICAgIHByaXZhdGUgcHJvY2Vzc05ld05vdGlmaWNhdGlvbnNGcm9tUmVzcG9uc2UocmVzcG9uc2UpIHtcbiAgICAgICAgY29uc3Qgbm90aWZpY2F0aW9ucyA9IHRoaXMuZ2V0Tm90aWZpY2F0aW9uc0Zyb21SZXNwb25zZShyZXNwb25zZSk7XG5cbiAgICAgICAgZm9yIChjb25zdCBuIG9mIG5vdGlmaWNhdGlvbnMpIHtcbiAgICAgICAgICAgIGlmIChuLmRhdGUgPiB0aGlzLmxhc3ROb3RpZmljYXRpb25EYXRlKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5sYXN0Tm90aWZpY2F0aW9uRGF0ZSA9IG4uZGF0ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBub3RpZmljYXRpb25zO1xuICAgIH1cblxuXG4gICAgcHJpdmF0ZSBnZXROb3RpZmljYXRpb25zRnJvbVJlc3BvbnNlKHJlc3BvbnNlKSB7XG4gICAgICAgIGNvbnN0IG5vdGlmaWNhdGlvbnM6IE5vdGlmaWNhdGlvbltdID0gW107XG5cbiAgICAgICAgZm9yIChjb25zdCBpIGluIHJlc3BvbnNlKSB7XG4gICAgICAgICAgICBub3RpZmljYXRpb25zW2ldID0gTm90aWZpY2F0aW9uLkNyZWF0ZShyZXNwb25zZVtpXSk7XG4gICAgICAgIH1cblxuICAgICAgICBub3RpZmljYXRpb25zLnNvcnQoKGEsIGIpID0+IGIuZGF0ZS52YWx1ZU9mKCkgLSBhLmRhdGUudmFsdWVPZigpKTtcbiAgICAgICAgbm90aWZpY2F0aW9ucy5zb3J0KChhLCBiKSA9PiAoYS5pc1Bpbm5lZCA9PT0gYi5pc1Bpbm5lZCkgPyAwIDogYS5pc1Bpbm5lZCA/IC0xIDogMSk7XG5cbiAgICAgICAgdGhpcy5yZWNlbnROb3RpZmljYXRpb25zID0gbm90aWZpY2F0aW9ucztcblxuICAgICAgICByZXR1cm4gbm90aWZpY2F0aW9ucztcbiAgICB9XG59XG4iXX0=